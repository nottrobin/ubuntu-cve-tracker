#!/usr/bin/env python
# This is used to generate both (via --editmoin):
#   https://wiki.ubuntu.com/Security/Features
# and (with --historical):
#   https://wiki.ubuntu.com/Security/Features/Historical
#
# Copyright 2008-2010 Canonical, Ltd.
# Author: Kees Cook <kees@ubuntu.com>
# License: GPLv3
import cve_lib, sys, optparse, os, tempfile

parser = optparse.OptionParser()
parser.add_option("--historical", help="Display all releases", action='store_true')
parser.add_option("--editmoin", help="Actually do the update using editmoin", action='store_true')
parser.add_option("--edit", help="Edit the generated output before handing it to editmoin", action='store_true')
(opt, args) = parser.parse_args()

target = sys.stdout
if opt.editmoin:
    # Make sure editmoin would actually work
    if not os.path.exists(os.path.expanduser('~/.moin_ids')) and not os.path.exists(os.path.expanduser('~/.moin_users')):
        print >>sys.stderr, "Error: Need to configure editmoin to use this option (usually ~/.moin_ids).\n"
        sys.exit(1)
    target = tempfile.NamedTemporaryFile(prefix='dump-features-', suffix='.txt')

config = cve_lib.read_config()

features = dict()

UNIMPLEMENTED = 0
AVAILABLE = 1
DEFAULT = 2
color = { UNIMPLEMENTED: 'dddddd', AVAILABLE: '98fd98', DEFAULT: '00dd00' }

#features[name]['short']
#features[name]['desc']
#features[name]['depth']
#features[name]['matrix']['dapper']['status'] = 'policy'
#features[name]['matrix']['dapper']['state'] = AVAILABLE

feature_list = [
	{ 'name':'configuration', 'short':'Configuration',
          'depth': 0,
	  'section':1, 'desc':'' },
	{ 'name':'ports', 'short':'No Open Ports',
          'depth': 1,
          'desc': '''<<Include(SecurityTeam/Policies, , from="== No Open Ports ==", to="==")>>

Testing for this can be done with `netstat -an --inet | grep LISTEN | grep -v 127.0.0.1:` on a fresh install.
''' },
	{ 'name':'hashing', 'short':'Password hashing',
          'depth': 1,
	  'desc':
'''The system password used for logging into Ubuntu is stored in /etc/shadow. Very old style password hashes were based on DES and visible in /etc/passwd. Modern Linux has long since moved to /etc/shadow, and for some time now has used salted MD5-based hashes for password verification (crypt id 1). Since MD5 is considered "broken" for some uses and as computational power available to perform brute-forcing of MD5 increases, Ubuntu 8.10 and later proactively moved to using salted SHA-512 based password hashes (crypt id 6), which are orders of magnitude more difficult to brute-force. See the [[Manpage:crypt|crypt]] manpage for additional details.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-glibc-security.py|test-glibc-security.py]] for regression tests.
''' },
	{ 'name':'syn-cookies', 'short':'SYN cookies',
          'depth': 1,
	  'desc':
'''When a system is overwhelmed by new network connections, SYN cookie use is activated, which helps mitigate a SYN-flood attack.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for configuration regression tests.
''' },
	{ 'name':'subsystems', 'short':'Subsystems',
          'depth': 0,
	  'section':1, 'desc':'' },
	{ 'name':'fscaps', 'short':'Filesystem Capabilities',
          'depth': 1,
	  'desc':
'''The need for setuid applications can be reduced via the application of [[http://www.olafdietsche.de/linux/capability/|filesystem capabilities]] using the xattrs available to most modern filesystems. This reduces the possible misuse of vulnerable setuid applications. The kernel provides the support, and the user-space tools are in main ("libcap2-bin").

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for configuration regression tests.
''' },
	{ 'name':'firewall', 'short':'Configurable Firewall',
          'depth': 1,
	  'desc':
'''[[UbuntuFirewall|ufw]] is a frontend for iptables, and is installed by default in Ubuntu (users must explicitly enable it). Particularly well-suited for host-based firewalls, ufw provides a framework for managing a netfilter firewall, as well as a command-line interface for manipulating the firewall. ufw aims to provide an easy to use interface for people unfamiliar with firewall concepts, while at the same time simplifies complicated iptables commands to help an administrator who knows what he or she is doing. ufw is an upstream for other distributions and graphical frontends.

See [[http://bazaar.launchpad.net/~ubuntu-branches/ubuntu/oneiric/ufw/oneiric/files/head:/tests/|ufw tests]] for regression tests.
''' },
	{ 'name':'seccomp', 'short':'PR_SET_SECCOMP',
          'depth': 1,
	  'desc':
'''Setting [[http://lwn.net/Articles/332974/|SECCOMP]] for a process is meant to confine it to a small subsystem of system calls, used for specialized processing-only programs.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'mac', 'short':'Mandatory Access Control (MAC)',
          'depth': 0,
	  'section':1, 'desc':'''Mandatory Access Controls are handled via the kernel LSM hooks.''' },
	{ 'name':'apparmor', 'short':'AppArmor',
          'depth': 1,
	  'desc':
'''[[https://help.ubuntu.com/community/AppArmor|AppArmor]] is a path-based MAC. Example profiles are found in the apparmor-profiles package from universe, and by-default shipped [[SecurityTeam/KnowledgeBase/AppArmorProfiles|enforcing profiles]] are being built up:

<<Include(SecurityTeam/KnowledgeBase/AppArmorProfiles, , from="=== Supported profiles in main ===", to="===")>>

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-apparmor.py|test-apparmor.py]] and [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'selinux', 'short':'SELinux',
          'depth': 1,
	  'desc':
'''[[SELinux]] is an inode-based MAC. Targeted policies are available for Ubuntu in universe. Installing the "selinux" package will make the boot-time adjustments that are needed.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for configuration regression tests.
''' },
	{ 'name':'smack', 'short':'SMACK',
          'depth': 1,
	  'desc':
'''SMACK is a flexible inode-based MAC.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for configuration regression tests.
''' },
	{ 'name':'encryption', 'short':'Filesystem encryption',
          'depth': 0,
          'section':1,
          'desc':'' },
	{ 'name':'encrypted-lvm', 'short':'Encrypted LVM',
          'depth': 1,
	  'desc':
'''Ubuntu 12.10 and newer include the ability to install Ubuntu onto an encrypted LVM, which allows all partitions in the logical volume, including swap, to be encrypted. Between 6.06 LTS and 12.04 LTS the alternate installer can install to an encrypted LVM.''' },
	{ 'name':'ecryptfs', 'short':'eCryptfs',
          'depth': 1,
	  'desc':
'''Encrypted Private Directories were implemented in Ubuntu 8.10 as a secure location for users to store sensitive information. The server and alternate installers had the option to setup an encrypted private directory for the first user. As of Ubuntu 9.04, support for encrypted home was added, allowing users to encrypt all files in their home directory. Encrypted Home is supported in the Alternate Installer, and available in the Desktop Installer via the preseed option `user-setup/encrypt-home=true`. Also, the Ubuntu 9.04 kernel carries a patchset for eCryptfs to support encrypted filenames.
''' },
	{ 'name':'userspace-hardening', 'short':'Userspace Hardening',
          'depth': 0,
	  'section':1, 'desc':
'''Many security features are available through the default [[CompilerFlags|compiler flags]] used to build packages and through the kernel in Ubuntu.''' },
	{ 'name':'stack-protector', 'short':'Stack Protector',
          'depth': 1,
	  'desc':
'''gcc's -fstack-protector provides a randomized stack canary that protects against stack overflows, and reduces the chances of arbitrary code execution via controlling return address destinations. Enabled at compile-time. (A small number of applications do not play well with it, and have it disabled.)  The routines used for stack checking are actually part of glibc, but gcc is patched to enable linking against those routines by default.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-gcc-security.py|test-gcc-security.py]] for regression tests.
''' },
	{ 'name':'heap-protector', 'short':'Heap Protector',
          'depth': 1,
	  'desc':
'''The GNU C Library heap protector (both automatic via [[http://www.malloc.de/en/|ptmalloc]] and [[http://www.gnu.org/s/libc/manual/html_node/Heap-Consistency-Checking.html|manual]]) provides corrupted-list/unlink/double-free/overflow protections to the glibc heap memory manager (first introduced in glibc 2.3.4). This stops the ability to perform arbitrary code execution via heap memory overflows that try to corrupt the control structures of the malloc heap memory areas.

This protection has evolved over time, adding more and more protections as additional [[http://www.phrack.com/issues.html?issue=66&id=10#article|corner-cases were researched]]. As it currently stands, glibc 2.10 and later appears to successfully resist even these hard-to-hit conditions.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-glibc-security.py|test-glibc-security.py]] for regression tests.
''' },
	{ 'name':'pointer-obfuscation', 'short':'Pointer Obfuscation',
          'depth': 1,
	  'desc':
'''Some [[http://udrepper.livejournal.com/13393.html|pointers stored in glibc are obfuscated]] via PTR_MANGLE/PTR_UNMANGLE macros internally in glibc, preventing libc function pointers from being overwritten during runtime.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-glibc-security.py|test-glibc-security.py]] for regression tests.
''' },
	{ 'name':'aslr', 'short':'Address Space Layout Randomisation (ASLR)',
          'depth': 1,
	  'section':1, 'desc':
'''ASLR is implemented by the kernel and the ELF loader by randomising the location of memory allocations (stack, heap, shared libraries, etc). This makes memory addresses harder to predict when an attacker is attempting a memory-corruption exploit. ASLR is controlled system-wide by the value of {{{/proc/sys/kernel/randomize_va_space}}}. Prior to Ubuntu 8.10, this defaulted to "1" (on). In later releases that included brk ASLR, it defaults to "2" (on, with brk ASLR).

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests for all the different types of ASLR.
''' },
	{ 'name':'stack-aslr', 'short':'Stack ASLR',
          'depth': 2,
	  'desc':
'''Each execution of a program results in a different stack memory space layout. This makes it harder to locate in memory where to attack or deliver an executable attack payload. This was available in the mainline kernel since 2.6.15 (Ubuntu 6.06).''' },
	{ 'name':'mmap-aslr', 'short':'Libs/mmap ASLR',
          'depth': 2,
	  'desc':
'''Each execution of a program results in a different mmap memory space layout (which causes the dynamically loaded libraries to get loaded into different locations each time). This makes it harder to locate in memory where to jump to for "return to libc" to similar attacks. This was available in the mainline kernel since 2.6.15 (Ubuntu 6.06).''' },
	{ 'name':'exec-aslr', 'short':'Exec ASLR',
          'depth': 2,
	  'desc':
'''Each execution of a program that has been built with "-fPIE -pie" will get loaded into a different memory location. This makes it harder to locate in memory where to attack or jump to when performing memory-corruption-based attacks. This was available in the mainline kernel since 2.6.25 (and was backported to Ubuntu 8.04 LTS).''' },
	{ 'name':'brk-aslr', 'short':'brk ASLR',
          'depth': 2,
	  'desc':
'''Similar to exec ASLR, brk ASLR adjusts the memory locations relative between the exec memory area and the brk memory area (for small mallocs). The randomization of brk offset from exec memory was added in 2.6.26 (Ubuntu 8.10), though some of the effects of brk ASLR can be seen for PIE programs in Ubuntu 8.04 LTS since exec was ASLR, and brk is allocated immediately after the exec region (so it was technically randomized, but not randomized with respect to the text region until 8.10).''' },
	{ 'name':'vdso-aslr', 'short':'VDSO ASLR',
          'depth': 2,
	  'desc':
'''Each execution of a program results in a random vdso location. While this has existed in the mainline kernel since 2.6.18 (x86, PPC) and 2.6.22 (x86_64), it hadn't been enabled in Ubuntu 6.10 due to COMPAT_VDSO being enabled, which was removed in Ubuntu 8.04 LTS. This protects against jump-into-syscall attacks. Only x86 (maybe ppc?) is supported by glibc 2.6. glibc 2.7 (Ubuntu 8.04 LTS) supports x86_64 ASLR vdso. People needing ancient pre-libc6 static high vdso mappings can use "vdso=2" on the kernel boot command line to gain COMPAT_VDSO again.

 * http://lwn.net/Articles/184734/
 * http://manugarg.googlepages.com/systemcallinlinux2_6.html
''' },
	{ 'name':'pie', 'short':'Built as PIE',
          'depth': 1,
	  'desc':
'''All programs built as Position Independent Executables (PIE) with "-fPIE -pie" can take advantage of the exec ASLR. This protects against "return-to-text" and generally frustrates memory corruption attacks. This requires centralized changes to the compiler options when building the entire archive. PIE has a large (5-10%) performance penalty on architectures with small numbers of general registers (e.g. x86), so it should only be used for a [[SecurityTeam/KnowledgeBase/BuiltPIE|select number of security-critical packages]] (some upstreams natively support building with PIE, other require the use of "hardening-wrapper" to force on the correct compiler and linker flags). PIE on x86_64 does not have the same penalties, and will eventually be made the default, but more testing is required.

<<Include(SecurityTeam/KnowledgeBase/BuiltPIE, , from="=== Supported Position Independent Executables in main ===", to="===")>>

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-built-binaries.py|test-built-binaries.py]] for regression tests.
''' },
	{ 'name':'fortify-source', 'short':'Built with Fortify Source',
          'depth': 1,
	  'desc':
'''Programs built with "-D_FORTIFY_SOURCE=2" (and -O1 or higher), enable several compile-time and run-time protections in glibc:
 * expand unbounded calls to "sprintf", "strcpy" into their "n" length-limited cousins when the size of a destination buffer is known (protects against memory overflows).
 * stop format string "%n" attacks when the format string is in a writable memory segment.
 * require checking various important function return codes and arguments (e.g. system, write, open).
 * require explicit file mask when creating new files.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-gcc-security.py|test-gcc-security.py]] for regression tests.
''' },
	{ 'name':'relro', 'short':'Built with RELRO',
          'depth': 1,
	  'desc':
'''Hardens ELF programs against loader memory area overwrites by having the loader mark any areas of the relocation table as read-only for any symbols resolved at load-time ("read-only relocations"). This reduces the area of possible GOT-overwrite-style memory corruption attacks.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-gcc-security.py|test-gcc-security.py]] for regression tests.
''' },
	{ 'name':'bindnow', 'short':'Built with BIND_NOW',
          'depth': 1,
	  'desc':
'''Marks ELF programs to resolve all dynamic symbols at start-up (instead of on-demand, also known as "immediate binding") so that the GOT can be made entirely read-only (when combined with RELRO above).

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-built-binaries.py|test-built-binaries.py]] for regression tests.
''' },
	{ 'name':'nx', 'short':'Non-Executable Memory',
          'depth': 1,
	  'desc':
'''Most modern CPUs protect against executing non-executable memory regions (heap, stack, etc). This is known either as Non-eXecute (NX) or eXecute-Disable (XD), and some BIOS manufacturers needlessly disable it by default, so check your [[Security/CPUFeatures|BIOS Settings]]. This protection reduces the areas an attacker can use to perform arbitrary code execution. It requires that the kernel use "PAE" addressing (which also allows addressing of physical addresses above 3GB). The 64bit and 32bit {{{-server}}} and {{{-generic-pae}}} kernels are compiled with PAE addressing. Starting in Ubuntu 9.10, this protection is partially emulated for processors lacking NX when running on a 32bit kernel (built with or without PAE). After booting, you can see what NX protection is in effect:
 * Hardware-based (via PAE mode): {{{
[    0.000000] NX (Execute Disable) protection: active}}}
 * Partial Emulation (via segment limits): {{{
[    0.000000] Using x86 segment limits to approximate NX protection}}}
If neither are seen, you do not have any NX protections enabled. Check your BIOS settings and CPU capabilities. If "nx" shows up in each of the "flags" lines in {{{/proc/cpuinfo}}}, it is enabled/supported by your hardware (and a PAE kernel is needed to actually use it).

Starting in Ubuntu 11.04, BIOS NX settings are [[http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=ae84739c27b6b3725993202fe02ff35ab86468e1|ignored by the kernel]].

|||||||||| \'\'\'Ubuntu 9.04 and earlier\'\'\'                                                                                                        ||
||||<rowspan=2>                                                      ||||                CPU supports NX                   || CPU lacks NX            ||
||                                                                         BIOS enables NX      ||     BIOS disables NX    ||                         ||
||<rowspan=2> i386 || {{{-386}}}, {{{-generic}}} kernel (non-PAE)    ||<#dd0000> nx unsupported ||<#dd0000> nx unsupported ||<#dd0000> nx unsupported ||
||                    {{{-server}}} kernel (PAE)                     ||<#00dd00> real nx        ||<#dd0000> nx unsupported ||<#dd0000> nx unsupported ||
|| amd64           || any kernel (PAE)                               ||<#00dd00> real nx        ||<#dd0000> nx unsupported ||<#dd0000> nx unsupported ||

|||||||||| \'\'\'Ubuntu 9.10 through 10.10\'\'\'                                                                                                      ||
||||<rowspan=2>                                                      ||||                CPU supports NX                   || CPU lacks NX            ||
||                                                                         BIOS enables NX      ||     BIOS disables NX    ||                         ||
||<rowspan=2> i386 || {{{-386}}}, {{{-generic}}} kernel (non-PAE)    ||<#dddd00> nx-emulation   ||<#dddd00> nx-emulation   ||<#dddd00> nx-emulation   ||
||                    {{{-server}}}, {{{-generic-pae}}} kernel (PAE) ||<#00dd00> real nx        ||<#dddd00> nx-emulation   ||<#dddd00> nx-emulation   ||
|| amd64           || any kernel (PAE)                               ||<#00dd00> real nx        ||<#dd0000> nx unsupported ||<#dd0000> nx unsupported ||


|||||||||| \'\'\'Ubuntu 11.04 and later\'\'\'                                                                              ||
||||                                                                 || CPU supports NX         || CPU lacks NX            ||
||<rowspan=2> i386 || {{{-386}}}, {{{-generic}}} kernel (non-PAE)    ||<#dddd00> nx-emulation   ||<#dddd00> nx-emulation   ||
||                    {{{-server}}}, {{{-generic-pae}}} kernel (PAE) ||<#00dd00> real nx        ||<#dddd00> nx-emulation   ||
|| amd64           || any kernel (PAE)                               ||<#00dd00> real nx        ||<#dd0000> nx unsupported ||

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'proc-maps', 'short':'/proc/$pid/maps protection',
          'depth': 1,
	  'desc':
'''With ASLR, a process's memory space layout suddenly becomes valuable to attackers. The "maps" file is [[http://lkml.org/lkml/2007/3/10/250|made read-only]] except to the process itself or the owner of the process. Went into mainline kernel with sysctl toggle in 2.6.22. The toggle was made non-optional in 2.6.27, forcing the privacy to be enabled regardless of sysctl settings (this is a good thing).

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'symlink', 'short':'Symlink restrictions',
          'depth': 1,
	  'desc':
'''A long-standing class of security issues is the symlink-based [[http://en.wikipedia.org/wiki/Time-of-check-to-time-of-use|ToCToU]] race, most commonly seen in world-writable directories like `/tmp/`. The common method of exploitation of [[http://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=tmp+symlink|this flaw]] is crossing privilege boundaries when following a given symlink (i.e. a `root` user follows a symlink belonging to another user).

In Ubuntu 10.10 and later, symlinks in world-writable sticky directories (e.g. `/tmp`) cannot be followed if the follower and directory owner do not match the symlink owner. The behavior is controllable through the `/proc/sys/kernel/yama/protected_sticky_symlinks` sysctl, available via [[http://zinc.canonical.com/git?p=kees/linux-2.6.git;a=shortlog;h=refs/heads/yama|Yama]].

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'hardlink', 'short':'Hardlink restrictions',
          'depth': 1,
	  'desc':
'''Hardlinks can be abused in a [[http://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=hardlink|similar fashion]] to symlinks above, but they are not limited to world-writable directories. If `/etc/` and `/home/` are on the same partition, a regular user can create a hardlink to `/etc/shadow` in their home directory. While it retains the original owner and permissions, it is possible for privileged programs that are otherwise symlink-safe to mistakenly access the file through its hardlink. Additionally, a very minor untraceable quota-bypassing local denial of service is possible by an attacker exhausting disk space by filling a world-writable directory with hardlinks.

In Ubuntu 10.10 and later, hardlinks cannot be created to files that the user would be unable to read and write originally, or are otherwise sensitive. The behavior is controllable through the `/proc/sys/kernel/yama/protected_nonaccess_hardlinks` sysctl, available via [[http://zinc.canonical.com/git?p=kees/linux-2.6.git;a=shortlog;h=refs/heads/yama|Yama]].

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'ptrace', 'short':'ptrace scope',
          'depth': 1,
	  'desc':
'''A troubling weakness of the Linux process
interfaces is that a single user is able to examine the memory and
running state of any of their processes. For example, if one application
was compromised, it would be possible for an attacker to
attach to other running processes (e.g. SSH sessions, GPG agent,
etc) to extract additional credentials and continue to immediately expand the scope
of their attack without resorting to user-assisted phishing or trojans.

In Ubuntu 10.10 and later, users cannot ptrace processes that are not a descendant of the debugger. The behavior is controllable through the `/proc/sys/kernel/yama/ptrace_scope` sysctl, available via [[http://zinc.canonical.com/git?p=kees/linux-2.6.git;a=shortlog;h=refs/heads/yama|Yama]].

In the case of automatic crash handlers, a crashing process can specficially allow an existing crash handler process to attach on a process-by-process basis using `prctl(PR_SET_PTRACER, debugger_pid, 0, 0, 0)`.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'kernel-hardening', 'short':'Kernel Hardening',
          'depth': 0,
	  'section':1, 'desc':
'''The kernel itself has protections enabled to make it more difficult to become compromised.''' },
	{ 'name':'null-mmap', 'short':'0-address protection',
          'depth': 1,
	  'desc':
'''Since the kernel and userspace share virtual memory addresses, the "NULL" memory space needs to be protected so that userspace mmap'd memory cannot start at address 0, stopping "NULL dereference" kernel attacks. This is possible with 2.6.22 kernels, and was implemented with the "mmap_min_addr" sysctl setting. Since Ubuntu 9.04, the mmap_min_addr setting is built into the kernel. (64k for x86, 32k for ARM.)

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'dev-mem', 'short':'/dev/mem protection',
          'depth': 1,
	  'desc':
'''Some applications (Xorg) need direct access to the physical memory from user-space. The special file `/dev/mem` exists to provide this access. In the past, it was possible to view and change kernel memory from this file if an attacker had root access. The [[http://lwn.net/Articles/267427/|CONFIG_STRICT_DEVMEM kernel option]] was introduced to block non-device memory access (originally named CONFIG_NONPROMISC_DEVMEM).

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'dev-kmem', 'short':'/dev/kmem disabled',
          'depth': 1,
	  'desc':
'''There is no modern user of `/dev/kmem` any more beyond attackers using it to load kernel rootkits. [[http://lkml.org/lkml/2008/2/10/328|CONFIG_DEVKMEM]] is set to "n". While the `/dev/kmem` device node still exists in Ubuntu 8.04 LTS through Ubuntu 9.04, it is not actually attached to anything in the kernel.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'block-modules', 'short':'Block module loading',
          'depth': 1,
	  'desc':
'''In Ubuntu 8.04 LTS and earlier, it was possible to [[http://www.debian.org/doc/manuals/securing-debian-howto/ch10.en.html#s-proactive|remove CAP_SYS_MODULES from the system-wide capability bounding set]], which would stop any new kernel modules from being loaded. This was another layer of protection to stop kernel rootkits from being installed. The 2.6.25 Linux kernel (Ubuntu 8.10) changed how bounding sets worked, and this functionality disappeared. Starting with Ubuntu 9.10, it is now [[http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=3d43321b7015387cfebbe26436d0e9d299162ea1|possible to block module loading]] again by setting "1" in {{{/proc/sys/kernel/modules_disabled}}}.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'rodata', 'short':'Read-only data sections',
      'depth': 1,
	  'desc':
'''This makes sure that certain kernel data sections are marked to block modification. This helps protect against some classes of kernel rootkits. Enabled via the CONFIG_DEBUG_RODATA option.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for configuration regression tests.
''' },
	{ 'name':'kernel-stack-protector', 'short':'Stack protector',
      'depth': 1,
	  'desc':
'''Similar to the stack protector used for ELF programs in userspace, the kernel can protect its internal stacks as well. Enabled via the CONFIG_CC_STACKPROTECTOR option.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for configuration regression tests.
''' },
	{ 'name':'module-ronx', 'short':'Module RO/NX',
      'depth': 1,
	  'desc':
'''This feature extends CONFIG_DEBUG_RODATA to include similar restrictions for loaded modules in the kernel. This can help resist future kernel exploits that depend on various memory regions in loaded modules. Enabled via the CONFIG_DEBUG_MODULE_RONX option.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for configuration regression tests.
''' },
	{ 'name':'kptr-restrict', 'short':'Kernel Address Display Restriction',
      'depth': 1,
	  'desc':
'''When attackers try to develop "run anywhere" exploits for kernel vulnerabilities, they frequently need to know the location of internal kernel structures. By treating kernel addresses as sensitive information, those locations are not visible to regular local users. Starting with Ubuntu 11.04, {{{/proc/sys/kernel/kptr_restrict}}} is set to "1" to block the reporting of known kernel address leaks. Additionally, various files and directories were made readable only by the root user: `/boot/vmlinuz*`, `/boot/System.map*`, `/sys/kernel/debug/`, `/proc/slabinfo`

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'blacklist-rare-net', 'short':'Blacklist Rare Protocols',
	  'depth': 1,
	  'desc':
'''Normally the kernel allows all network protocols to be autoloaded on demand via the {{{MODULE_ALIAS_NETPROTO(PF_...)}}} macros. Since many of these protocols are old, rare, or generally of little use to the average Ubuntu user and may contain undiscovered exploitable vulnerabilities, they have been blacklisted since Ubuntu 11.04. These include: ax25, netrom, x25, rose, decnet, econet, rds, and af_802154. If any of the protocols are needed, they can speficially loaded via modprobe, or the {{{/etc/modprobe.d/blacklist-rare-network.conf}}} file can be updated to remove the blacklist entry.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
	{ 'name':'seccomp-filter', 'short':'Syscall Filtering',
	  'depth': 1,
	  'desc':
'''Programs can filter out the availability of kernel syscalls by using the [[https://lkml.org/lkml/2011/6/23/784|seccomp_filter interface]]. This is done in containers or sandboxes that want to further limit the exposure to kernel interfaces when potentially running untrusted software.

See [[http://bazaar.launchpad.net/~ubuntu-bugcontrol/qa-regression-testing/master/view/head:/scripts/test-kernel-security.py|test-kernel-security.py]] for regression tests.
''' },
#	{ 'name':'', 'short':'',
#	  'depth': 1,
#	  'desc':
#''' ''' },
]

for details in feature_list:
    features.setdefault(details['name'], dict())
    for item in details.keys():
        if item == 'name':
            continue
        features[details['name']].setdefault(item, details[item])
    features[details['name']].setdefault('matrix', dict())
    for rel in cve_lib.releases:
        features[details['name']]['matrix'].setdefault(rel, dict())
        features[details['name']]['matrix'][rel].setdefault('status', '--')
        features[details['name']]['matrix'][rel].setdefault('state',
                                                            UNIMPLEMENTED)

def add_status(name, release, status, state):
    overwrite = False
    for rel in cve_lib.releases:
        if rel == release:
            overwrite = True
        if overwrite:
            features[name]['matrix'][rel]['status'] = status
            features[name]['matrix'][rel]['state'] = state

add_status('ports', 'dapper', 'policy', DEFAULT)

add_status('hashing', 'dapper', 'md5', DEFAULT)
add_status('hashing', 'intrepid', 'sha512', DEFAULT)

add_status('apparmor', 'feisty', '2.0 (universe)', AVAILABLE)
add_status('apparmor', 'gutsy', '2.1', DEFAULT)
add_status('apparmor', 'hardy', '2.1', DEFAULT)
add_status('apparmor', 'intrepid', '2.3', DEFAULT)
add_status('apparmor', 'karmic', '2.3.1', DEFAULT)
add_status('apparmor', 'lucid', '2.5', DEFAULT)
add_status('apparmor', 'maverick', '2.5.1', DEFAULT)
add_status('apparmor', 'natty', '2.6.1', DEFAULT)
add_status('apparmor', 'oneiric', '2.7.0~beta1', DEFAULT)
add_status('apparmor', 'precise', '2.7.0', DEFAULT)
add_status('apparmor', 'quantal', '2.8.0', DEFAULT)
add_status('apparmor', 'raring', '2.8.0', DEFAULT)

add_status('selinux', 'hardy', 'universe', AVAILABLE)

add_status('smack', 'intrepid', 'kernel', AVAILABLE)

add_status('fscaps', 'intrepid', 'kernel', AVAILABLE)

add_status('firewall', 'dapper', 'iptables', DEFAULT)
add_status('firewall', 'hardy', 'ufw', DEFAULT)

add_status('encrypted-lvm', 'dapper', 'alt installer', AVAILABLE)
add_status('encrypted-lvm', 'quantal', 'main installer', AVAILABLE)

add_status('ecryptfs', 'intrepid', '~/Private', AVAILABLE)
add_status('ecryptfs', 'jaunty', '~/Private or ~, filenames', AVAILABLE)

add_status('stack-protector', 'edgy', 'gcc patch', DEFAULT)

add_status('heap-protector', 'dapper', 'glibc', DEFAULT)

add_status('pointer-obfuscation', 'hardy', 'glibc', DEFAULT)

add_status('stack-aslr', 'dapper', 'kernel', DEFAULT)

add_status('mmap-aslr', 'dapper', 'kernel (i386 only)', DEFAULT)
add_status('mmap-aslr', 'hardy', 'kernel', DEFAULT)

add_status('exec-aslr', 'hardy', 'kernel (-mm patch)', DEFAULT)
add_status('exec-aslr', 'intrepid', 'kernel', DEFAULT)

add_status('brk-aslr', 'hardy', 'kernel (exec ASLR)', AVAILABLE)
add_status('brk-aslr', 'intrepid', 'kernel', DEFAULT)

add_status('vdso-aslr', 'hardy', 'kernel', DEFAULT)

add_status('pie', 'intrepid', 'package list', DEFAULT)

add_status('fortify-source', 'intrepid', 'gcc patch', DEFAULT)

add_status('relro', 'intrepid', 'gcc patch', DEFAULT)

add_status('bindnow', 'karmic', 'package list', DEFAULT)

add_status('nx', 'dapper', 'PAE only', DEFAULT)
add_status('nx', 'karmic', 'PAE, ia32 partial-NX-emulation', DEFAULT)

add_status('proc-maps', 'hardy', 'kernel & sysctl', DEFAULT)
add_status('proc-maps', 'intrepid', 'kernel', DEFAULT)

add_status('null-mmap', 'hardy', 'kernel & sysctl', DEFAULT)
add_status('null-mmap', 'jaunty', 'kernel', DEFAULT)

add_status('dev-mem', 'dapper', 'kernel', DEFAULT)
add_status('dev-mem', 'edgy', '--', UNIMPLEMENTED)
add_status('dev-mem', 'hardy', 'kernel (-mm patch)', DEFAULT)
add_status('dev-mem', 'intrepid', 'kernel', DEFAULT)

add_status('dev-kmem', 'hardy', 'kernel (-mm patch)', DEFAULT)
add_status('dev-kmem', 'intrepid', 'kernel', DEFAULT)

add_status('block-modules', 'dapper', 'drop CAP_SYS_MODULES', AVAILABLE)
add_status('block-modules', 'intrepid', '--', UNIMPLEMENTED)
add_status('block-modules', 'karmic', 'sysctl', AVAILABLE)

add_status('seccomp', 'hardy', 'kernel', AVAILABLE)

add_status('syn-cookies', 'warty', 'kernel', AVAILABLE)
add_status('syn-cookies', 'jaunty', 'kernel & sysctl', DEFAULT)

add_status('rodata', 'hardy', 'kernel', DEFAULT)

add_status('kernel-stack-protector', 'jaunty', 'kernel', DEFAULT)

add_status('symlink', 'maverick', 'kernel', DEFAULT)

add_status('hardlink', 'maverick', 'kernel', DEFAULT)

add_status('ptrace', 'maverick', 'kernel', DEFAULT)

add_status('kptr-restrict', 'natty', 'kernel', DEFAULT)

add_status('module-ronx', 'natty', 'kernel', DEFAULT)

add_status('blacklist-rare-net', 'natty', 'kernel', DEFAULT)

add_status('seccomp-filter', 'oneiric', 'kernel', AVAILABLE)


target.write('''
## This page was auto-generated using http://bazaar.launchpad.net/%7Eubuntu-security/ubuntu-cve-tracker/master/annotate/head%3A/scripts/dump-features

= Matrix =
||<#00dd00> '\''By Default'\'' ||
||<#98fd98> '\''Available'\'' ||
||<#dddddd> '\''Unimplemented'\'' ||

|| '\''feature'\''              ||''')

# Report release name headers
for rel in cve_lib.releases:
    if not opt.historical and rel in cve_lib.eol_releases:
        continue
    name = cve_lib.release_names[rel].replace('Ubuntu ',"'\''").replace(' (',"'\'' (")
    target.write('%-20s ||' % (name))
target.write("\n")

for details in feature_list:
    if details.has_key('section'):
        continue

    name = details['name']
    target.write('|| [[#%s|%20s]] ||' % (name, features[name]['short']))

    for rel in cve_lib.releases:
        if not opt.historical and rel in cve_lib.eol_releases:
            continue
        item = features[name]['matrix'][rel]
        target.write('<#%s> %-20s ||' % (color[item['state']], item['status']))
    target.write('\n')

target.write('''
||<tablestyle="float:right; font-size: 0.9em; width:30%; background:#F1F1ED; background-repeat: no-repeat; background-position:  98% 0.5ex; margin: 0 0 1em 1em; padding: 0.5em;"><<TableOfContents>>||

''')
target.write('= Features =\n\n')
for details in feature_list:
    name = details['name']
    depth = '==' + '=' * features[name]['depth']

    target.write('<<Anchor(%s)>>\n' % (name))
    target.write('%s %s %s\n' % (depth, features[name]['short'], depth))
    target.write('%s\n\n' % (features[name]['desc']))

target.write('''= Additional Documentation =
 * Coordination with Debian: http://wiki.debian.org/Hardening
 * Gentoo's Hardening project: http://www.gentoo.org/proj/en/hardened/hardened-toolchain.xml
''')
if not opt.historical:
    target.write(' * [[/Historical|Ubuntu Security Features for all releases]]\n')

target.flush()

if opt.editmoin:
    os.environ['EDITMOIN_FILE'] = target.name
    os.environ['EDITMOIN_COMMENT'] = 'automatic refresh'
    script = tempfile.NamedTemporaryFile(prefix='editmoin-script-',
                                         suffix='.sh')
    script.write('''#!/bin/sh
set -e
if [ ! -f "$@" ]; then
    exit 1
fi
output=$(mktemp -t editmoin-script-output-XXXXXX)
grep '@@' "$@" | sed -e 's/^@@ Comment: .*/@@ Comment: '"$EDITMOIN_COMMENT"'/' >> "$output" || true
cat "$EDITMOIN_FILE" >> "$output"
mv "$output" "$@"
''')
    if opt.edit:
        script.write('exec ${DUMPFEATURES_EDITOR} "$@"\n')
    script.flush()
    os.environ['DUMPFEATURES_EDITOR'] = os.environ.get('EDITOR','vi')
    os.environ['EDITOR'] = 'sh %s' % (script.name)
    url = 'https://wiki.ubuntu.com/Security/Features'
    if opt.historical:
        url += '/Historical'
    print "Refreshing %s ..." % (url)
    os.system("editmoin %s" % (url))
    os.environ['EDITOR'] = os.environ['DUMPFEATURES_EDITOR']

    if not opt.historical:
        os.execv(sys.argv[0], sys.argv + ['--historical'])
