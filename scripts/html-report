#!/bin/sh -e

# Author: Jamie Strandboge <jamie@ubuntu.com>
# Author: Kees Cook <kees@ubuntu.com>
# Copyright (C) 2005-2008 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

#
# USAGE:
# scripts/html-report -d ~/public_html/cve 
# scripts/html-report -d ~/public_html/cve -S
#
# '-d' specifies the output directory for the html
#

if [ "$1" = "-h" ]; then
cat << EOM
html-report -d <dir> [-S]
 -S show only official releases
 -d output directory
EOM
    exit 0
fi

# setup the output directory
outdir=""
if [ "$1" != "-d" ] || [ -z "$2" ]; then
    $0 -h
    exit 1
else
    outdir="$2"
    shift 2
    mkdir "$outdir" 2>/dev/null || true
fi

if [ ! -d "$outdir" ]; then
    echo "ERROR: '$outdir' does not exist"
    exit 1
fi

# setup the temp directory
tmpdir=`mktemp -d`
trap "rm -rf ${tmpdir}" EXIT

suffix=""
table_args=""
if [ "$1" = "-S" ]; then
    suffix="-released"
    table_args="$1"
    shift
fi


OUTPUT=$(./scripts/ubuntu-table --html --supported --no-retired $table_args)
#for show in main universe partner index
for show in main universe partner
do
    outfile="${tmpdir}/${show}${suffix}.html"
    cat > "$outfile" <<EOM
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Ubuntu CVE Tracker</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="author" content="Canonical Ltd, Kees Cook and Jamie Strandboge" />
<meta name="description" content="Ubuntu CVE Tracker" />
<meta name="copyright" content="Canonical Ltd" />
<link rel="StyleSheet" href="toplevel.css" type="text/css" />

</head>

<body>
<div id="container">
<h2>Ubuntu CVE Tracker</h2>
<h3>Introduction</h3>
<p class="intro">Ubuntu tracks its security vulnerabilities via the <a
href="https://launchpad.net/ubuntu-cve-tracker">Ubuntu CVE Tracker</a>. 
This report is divided into the following sections:</p>
<ul>
  <li><a href="main${suffix}.html#main">Main</a> (supported by Canonical Ltd)</li>
  <li><a href="universe${suffix}.html#universe">Universe</a> (supported by the Ubuntu community)</li>
  <li><a href="partner${suffix}.html#partner">Partner</a> (supported by upstream vendor)</li>
</ul>

<p><a href="risk.html">Risk Color Key</a></p>
EOM

    if [ "$show" = "main" ]; then
        echo "<h3 id='main'>Main</h3>" >> "$outfile"
        # all this sed work strips out the last column
        echo "$OUTPUT" | egrep '(<table>|</table>|<th>|SUPPORTED)' | egrep -v 'EMBARGOED' | sed -r 's#<td>[[:space:]]+<p>[[:space:]]*[a-zA-Z0-9\-]*[[:space:]]*</p>[[:space:]]+</td>[[:space:]]+</tr>$#</tr>#' | sed -r 's#<th>Notes</th></tr>$#</tr>#' >> "$outfile"
        echo "<p class='note'>* supported by Canonical Ltd</p>" >> "$outfile"
    elif [ "$show" = "universe" ]; then
        echo "<h3 id='universe'>Universe</h3>" >> "$outfile"
        echo "$OUTPUT" | egrep -v '(PARTNER|SUPPORTED|EMBARGOED)' | egrep -v 'EMBARGOED'| sed -r 's#<td>[[:space:]]+</td>[[:space:]]+</tr>$#</tr>#' | sed -r 's#<th>Notes</th></tr>$#</tr>#' >> "$outfile"
    elif [ "$show" = "partner" ]; then
        echo "<h3 id='partner'>Partner</h3>" >> "$outfile"
        echo "$OUTPUT" | egrep '(<table>|</table>|<th>|PARTNER)' | egrep -v 'EMBARGOED'| sed -r 's#<td>[[:space:]]+<p>[[:space:]]*[a-zA-Z0-9\-]*[[:space:]]*</p>[[:space:]]+</td>[[:space:]]+</tr>$#</tr>#' | sed -r 's#<th>Notes</th></tr>$#</tr>#' >> "$outfile"
    fi

    NOW=$(date -u +"%Y-%m-%d %R %Z")
    COMMIT=$(bzr log --limit=1 --line | cut -d: -f1)
    cat >> "$outfile" <<EOM
<p id="w3c">
  <a href="http://validator.w3.org/check?uri=referer"><img
    src="http://www.w3.org/Icons/valid-xhtml10"
    alt="Valid XHTML 1.0 Strict" height="31" width="88" style="border: 0;"/></a>
</p>
<p class='note'><a href="https://code.launchpad.net/~ubuntu-security/ubuntu-cve-tracker/master">Updated</a>: ${NOW} (commit <a href="http://bazaar.launchpad.net/~ubuntu-security/ubuntu-cve-tracker/master/revision/${COMMIT}">${COMMIT}</a>)</p>
</div>
<div id="footer">
EOM
    echo "&copy; Canonical Ltd. 2007-`date +%Y`" >> "$outfile"
    cat >> "$outfile" <<EOM
</div>
</body>
</html>
EOM
done

mv -f ${tmpdir}/* ${outdir}
