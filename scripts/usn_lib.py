#!/usr/bin/python

# Author: Kees Cook <kees@ubuntu.com>
# Author: Jamie Strandboge <jamie@ubuntu.com>
# Copyright (C) 2005-2011 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

import os, sys, cPickle, subprocess
from source_map import version_compare

def load_database(db_filename='database.pickle'):
    '''Load usn database'''
    filename = os.path.expanduser(db_filename)
    if not os.path.isfile(filename):
        return {}
    return cPickle.load(open(filename))

def save_database(database, db_filename='database.pickle'):
    '''Save usn database'''
    filename = os.path.expanduser(db_filename)
    cPickle.dump(database, open(filename, 'w'), -1)

def get_reverted(filename='reverted-CVEs.txt'):
    '''Get reverted USNs'''
    reverted = dict()
    if os.path.exists(filename):
        for line in open(filename):
            elements = line.rstrip().split(' ')
            usn = elements.pop(0)
            reverted.setdefault(usn,set())
            for cve in elements:
                reverted[usn].add(cve)

    return reverted

def packages_dict(db, packages, releases=None, opt=object):
    '''Produce a list of packages that refer back to USNs'''
    pkgs = dict()
    for usn in sorted(db, cmp=version_compare):
        # This USN is ancient and lacks any CVE information
        if not db[usn].has_key('cves'):
            if (hasattr(opt, 'debug') and opt.debug):
                print "%s lacks CVEs" % (usn)
            continue

        for rel in db[usn]['releases']:
            # Ignore old USNs
            if not db[usn]['releases'][rel].has_key('sources'):
                continue

            if releases and not rel in releases:
                continue

            # Look at fixed packages
            for pkg in packages:
                if not db[usn]['releases'][rel]['sources'].has_key(pkg):
                    continue

                pkgs.setdefault(pkg, dict())
                version = db[usn]['releases'][rel]['sources'][pkg]['version']
                if pkgs[pkg].has_key(version):
                    raise IndexError, "Saw %s %s twice!" % (pkg, version)
                pkgs[pkg][version] = usn
    return pkgs

def _update_usn_description(db, usn):
    db[usn]['description'] = subprocess.check_output(['%s/pull-usn-desc.py' % (os.path.dirname(sys.argv[0])),'--prioritize'] + db[usn]['cves'])
    if 'XXX' in db[usn]['description']:
        raise ValueError, "Missing descriptions in USN %s:\n%s" % (usn, db[usn]['description'])

def del_cves(db, usn, rm_cves=[]):
    cves = set(db[usn]['cves'])
    cves.difference_update(rm_cves)
    db[usn]['cves'] = sorted(cves)
    _update_usn_description(db, usn)

def add_cves(db, usn, new_cves=[]):
    db[usn]['cves'] = sorted(set(db[usn]['cves'] + new_cves))
    _update_usn_description(db, usn)
